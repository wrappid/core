name: Create-Tag

on:
  workflow_dispatch:
    inputs:
      version_type:
        type: choice
        description: Choose version bump type
        options: 
        - -r major
        - -r minor
        - -r patch
        - -p alpha
        - -p beta
        - -p build
        - -p hotfix
        - -p build
        required: true
        default: "-r patch"
  pull_request:
    types:
      - closed
    branches:
      - 'development'

jobs:        
  create_tag:
    runs-on: ubuntu-latest
    permissions: write-all
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'development')
    env:
      GITHUB_TOKEN: ${{ secrets.PAT }}

    steps:

      - name: ðŸ›  Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 16

      - name: ðŸ›’ Checkout repository
        uses: actions/checkout@v4


      - name: ðŸ›  Setup gh and git
        run: |
          # echo ${{secrets.PAT}} | gh auth login --with-token
          git config user.name "${{ secrets.GHUSER_NAME }}"
          git config user.email "${{ secrets.GHUSER_EMAIL }}"
        # env:
        #   GITHUB_TOKEN: ${{ secrets.PAT }}

      - name: ðŸ‘€ Process Inputs
        id: release-type-input
        run: |
          if [ -z "${{ github.event.inputs.version_type }}" ]; then
            echo "Setting default version type"
            export VERSION_TYPE_DEFAULT=" -r patch"
          else
            export VERSION_TYPE_DEFAULT="${{ github.event.inputs.version_type }}"
          fi
          echo "Version type: $VERSION_TYPE_DEFAULT"
          echo "::set-output name=version_type::$VERSION_TYPE_DEFAULT"


      - name: â¬‡ï¸ Setup Project
        run: | 
         echo Installing Node Modules
         npm ci

      - name: ðŸ”„ Update Attribution
        run: |
         npm run attributions:gen
         chmod +x ./.github/scripts/attribution_header_adder.sh
         bash ./.github/scripts/attribution_header_adder.sh ${{ github.event.repository.name }}
         git pull
         git add ATTRIBUTIONS.md
         git commit -m "docs(global): :memo: update attribution

         update attributions content

         by Publish CI"
        # env:
        #   GITHUB_TOKEN: ${{ secrets.PAT }}

      - name: â¬†ï¸ Update version
        run:  npm run release -- ${{ steps.release-type-input.outputs.version_type}}


      - name: ðŸš€ Update remote repository
        run: git push --follow-tags origin development
        # env:
        #   GITHUB_TOKEN: ${{ secrets.PAT }}

      - name: Get Version
        id: get-version
        run: echo "jq -r '.version' package.json" >> $GITHUB_OUTPUT 

      - name: ðŸ“§ Send mail
        uses: dawidd6/action-send-mail@v3
        with:
            server_address: smtp.gmail.com
            server_port: 465
            username: ${{secrets.MAIL_USERNAME}}
            password: ${{secrets.MAIL_PASSWORD}}
            secure: true
            from: Wrappid Care
            to: ${{secrets.IDS}}
            cc: ${{secrets.MAINTAINER_ID}}
            subject: Tag Created ${{ github.event.repository.name }} - ${{ steps.get_version.outputs.version }}. ðŸš€
            html_body: |
              <html lang="en">

              <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Exciting News from Wrappiders</title>
              </head>

              <body>
                <p>Hi Maintainers,</p>

                <p>
                  Tag released ${{ github.event.repository.name }}, ${{ steps.get_version.outputs.version }}. ðŸš€<br>
                  You can check out the details on our <a href="https://github.com/wrappid/${{ github.event.repository.name }}/releases/latest">${{ github.event.repository.name }} page</a>.
                </p>

                <p>Thanks and Regards,<br>
                  ${{github.actor}}<br>
                  (Generated by the create-tag GitHub Action workflow)</p>
              </body>

              </html>